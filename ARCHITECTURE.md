# Архитектура приложения

## Общая структура

```
project/
├── backend/              # Node.js + Express API
│   ├── config/          # Конфигурация БД
│   ├── middleware/      # Middleware (аутентификация, валидация)
│   ├── routes/          # API маршруты
│   ├── server.js        # Главный файл сервера
│   ├── package.json
│   └── Dockerfile
│
├── frontend/            # React приложение
│   ├── src/
│   │   ├── api/         # API клиент и сервисы
│   │   ├── pages/       # Страницы компонентов
│   │   ├── App.js       # Главный компонент
│   │   └── index.js
│   ├── public/          # Статические файлы
│   ├── package.json
│   └── Dockerfile
│
├── database/            # SQL скрипты
│   └── schema.sql       # Схема базы данных
│
├── docker-compose.yml   # Конфигурация контейнеров
├── .env.example         # Пример переменных окружения
├── README.md           # Основная документация
├── INSTALLATION.md     # Руководство установки
├── API_DOCUMENTATION.md # Документация API
└── ARCHITECTURE.md     # Описание архитектуры
```

## Компоненты системы

### 1. Frontend (React)

**Технологии:**
- React 18
- React Router v6
- Axios для HTTP запросов
- CSS для стилизации

**Структура:**
- `LoginPage` - страница авторизации
- `StudentDashboard` - личный кабинет ученика
- `CookDashboard` - кабинет повара (для реализации)
- `AdminDashboard` - админ панель (для реализации)

**Функции:**
- Аутентификация и управление сессией
- Просмотр и управление заказами
- Просмотр меню и оставление отзывов
- Управление платежами

### 2. Backend (Node.js + Express)

**Технологии:**
- Express.js для создания API
- PostgreSQL для хранения данных
- JWT для аутентификации
- bcryptjs для хеширования паролей

**Маршруты:**
- `/api/auth` - аутентификация и профиль
- `/api/menu` - меню и блюда
- `/api/orders` - заказы
- `/api/payments` - платежи
- `/api/reviews` - отзывы
- `/api/purchases` - заявки на закупки и инвентарь
- `/api/admin` - административные функции

**Middleware:**
- `cors` - обработка кросс-доменных запросов
- `helmet` - безопасность HTTP заголовков
- `morgan` - логирование запросов
- `authenticateToken` - проверка JWT токена
- `authorizeRole` - проверка ролей

### 3. База данных (PostgreSQL)

**Таблицы:**
- `users` - пользователи системы
- `menu` - блюда меню
- `orders` - заказы учеников
- `payments` - платежи
- `reviews` - отзывы о блюдах
- `purchase_requests` - заявки на закупку
- `inventory` - инвентарь продуктов

**Индексы:**
- По email пользователей
- По датам меню и заказов
- По ID пользователей и блюд

## Поток данных

### 1. Аутентификация

```
Пользователь → Frontend (LoginPage) → POST /api/auth/login
                                        ↓
                                   Backend проверка пароля
                                        ↓
                                   Генерация JWT токена
                                        ↓
                               Frontend сохраняет токен в localStorage
                                        ↓
                          Токен отправляется в Authorization заголовке
```

### 2. Просмотр меню и заказ

```
Ученик → Frontend (StudentDashboard) → GET /api/menu/:date
                                              ↓
                                    Backend запрос к БД
                                              ↓
                                    Возврат меню ученику
                                              ↓
                             Ученик выбирает блюдо → POST /api/orders
                                              ↓
                                    Backend сохраняет заказ
                                              ↓
                                 Подтверждение ученику
```

### 3. Управление платежами

```
Ученик → Frontend → Форма оплаты → POST /api/payments
                                         ↓
                                  Backend создает запись платежа
                                         ↓
                          Платеж ожидает подтверждения (статус: pending)
                                         ↓
                  Администратор → PUT /api/admin/payments/:id/confirm
                                         ↓
                              Платеж подтвержден (статус: completed)
```

## Безопасность

### Аутентификация
- Использование JWT токенов со временем жизни 24 часа
- Токены хранятся в localStorage на клиенте
- Пароли хешируются с bcryptjs (10 раундов)

### Авторизация
- Проверка ролей пользователя на каждом защищенном маршруте
- Роли: `student`, `cook`, `admin`
- Доступ к ресурсам ограничен по ролям

### Передача данных
- HTTPS в продакшене (через nginx reverse proxy)
- CORS настроен на уровне приложения
- Валидация входных данных на сервере
- Helmet.js для безопасности HTTP заголовков

### Защита БД
- Параметризованные запросы (защита от SQL-инъекций)
- Пароли БД в переменных окружения
- Резервные копии данных

## Масштабируемость

### Горизонтальное масштабирование
- Контейнеризация с Docker Compose
- Возможность добавления нескольких инстансов backend
- Load balancer (nginx) для распределения нагрузки

### Вертикальное масштабирование
- Настройка ресурсов контейнеров
- Оптимизация запросов БД через индексы
- Кеширование часто запрашиваемых данных

### Оптимизация БД
- Индексы на поля, используемые в WHERE и JOIN
- Кластеризация по датам для архивирования
- Регулярное обслуживание (VACUUM, ANALYZE)

## Развёртывание

### Локальное (разработка)
```
docker-compose up -d
```

### Производство
```
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
```

Требуется:
- nginx reverse proxy с SSL
- Переменные окружения для продакшена
- Регулярное резервное копирование БД
- Мониторинг и логирование

## Возможные улучшения

1. **Кеширование**
   - Redis для кеширования часто используемых данных
   - Кеш меню на уровне frontend

2. **Асинхронность**
   - Message queue (RabbitMQ) для отправки уведомлений
   - Background jobs для отчетов

3. **Масштабируемость БД**
   - Репликация PostgreSQL
   - Шардирование по школам (для сети столовых)

4. **Микросервисы**
   - Отделение платежной системы
   - Отделение уведомлений в отдельный сервис

5. **Мониторинг**
   - ELK Stack для логирования
   - Prometheus + Grafana для метрик
   - Sentry для отслеживания ошибок

6. **Testing**
   - Unit тесты для backend и frontend
   - Integration тесты для API
   - E2E тесты для пользовательских сценариев

## Диаграмма взаимодействия

```
┌─────────────┐
│   Frontend  │ (React, Axios)
│  (Port 3000)│
└──────┬──────┘
       │
       │ HTTP/HTTPS
       │
┌──────▼──────────────────┐
│   Backend API           │ (Node.js + Express)
│   (Port 5000)           │
│ ┌─────────────────────┐ │
│ │ /auth               │ │
│ │ /menu               │ │
│ │ /orders             │ │
│ │ /payments           │ │
│ │ /reviews            │ │
│ │ /purchases          │ │
│ │ /admin              │ │
│ └─────────────────────┘ │
└──────┬──────────────────┘
       │
       │ SQL Queries
       │
┌──────▼──────────────────┐
│   PostgreSQL            │
│   (Port 5432)           │
│ ┌─────────────────────┐ │
│ │ users               │ │
│ │ menu                │ │
│ │ orders              │ │
│ │ payments            │ │
│ │ reviews             │ │
│ │ purchase_requests   │ │
│ │ inventory           │ │
│ └─────────────────────┘ │
└─────────────────────────┘
```
